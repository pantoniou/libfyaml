name: macOS Latest Test

on:
  push:
    branches: [ master, main ]
  pull_request:
    branches: [ master, main ]
  workflow_dispatch:

jobs:
  autotools-clang:
    name: Autotools with Clang
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew update
        brew install autoconf automake libtool pkg-config check libyaml

    - name: Bootstrap
      run: ./bootstrap.sh

    - name: Configure
      run: ./configure

    - name: Build
      run: make -j$(sysctl -n hw.ncpu)

    - name: Test
      run: make check

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-macos-autotools-clang
        path: |
          test/*.log
          test-suite.log

  autotools-gcc:
    name: Autotools with GCC
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew update
        brew install autoconf automake libtool pkg-config check libyaml gcc@13

    - name: Set compiler environment
      run: |
        echo "CC=gcc-13" >> $GITHUB_ENV
        echo "CXX=g++-13" >> $GITHUB_ENV

    - name: Bootstrap
      run: ./bootstrap.sh

    - name: Configure
      run: ./configure

    - name: Build
      run: make -j$(sysctl -n hw.ncpu)

    - name: Test
      run: make check

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-macos-autotools-gcc
        path: |
          test/*.log
          test-suite.log

  cmake-clang-debug:
    name: CMake with Clang (Debug)
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew update
        brew install cmake ninja pkg-config check libyaml

    - name: Configure
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Debug \
          -DBUILD_TESTING=ON \
          -DENABLE_NETWORK=ON

    - name: Build
      run: cmake --build build

    - name: Test
      working-directory: build
      run: ctest --output-on-failure

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-macos-cmake-clang-debug
        path: |
          build/Testing/Temporary/
          build/**/*.log

  cmake-gcc-release:
    name: CMake with GCC (Release)
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew update
        brew install cmake ninja pkg-config check libyaml gcc@13

    - name: Set compiler environment
      run: |
        echo "CC=gcc-13" >> $GITHUB_ENV
        echo "CXX=g++-13" >> $GITHUB_ENV

    - name: Configure
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTING=ON \
          -DENABLE_NETWORK=ON

    - name: Build
      run: cmake --build build

    - name: Test
      working-directory: build
      run: ctest --output-on-failure

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-macos-cmake-gcc-release
        path: |
          build/Testing/Temporary/
          build/**/*.log

  cmake-with-llvm:
    name: CMake with LLVM (Reflection)
    runs-on: macos-latest

    steps:
    - uses: actions/checkout@v4

    - name: Install dependencies
      run: |
        brew update
        brew install cmake ninja pkg-config check libyaml llvm

    - name: Configure with LLVM
      run: |
        cmake -B build -G Ninja \
          -DCMAKE_BUILD_TYPE=Release \
          -DBUILD_TESTING=ON \
          -DENABLE_NETWORK=ON \
          -DCMAKE_PREFIX_PATH="$(brew --prefix llvm)"

    - name: Build
      run: cmake --build build

    - name: Test
      working-directory: build
      run: ctest --output-on-failure

    - name: Verify reflection support
      working-directory: build
      run: |
        # Check if fy-tool was built with reflection support
        ./src/tool/fy-tool --help | grep -q reflect && echo "✓ Reflection support enabled" || echo "⚠ Reflection not available"

    - name: Upload test logs on failure
      if: failure()
      uses: actions/upload-artifact@v4
      with:
        name: test-logs-macos-cmake-llvm
        path: |
          build/Testing/Temporary/
          build/**/*.log
